<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, viewport-fit=cover"
        />
        <title>Interactive Trip Itinerary</title>
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Caveat:wght@600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"
        />
        <style>
            :root {
                --bg: #f4efe6;
                --surface: #fffdf8;
                --surface-muted: #f8f3ea;
                --text-primary: #1e2a33;
                --text-secondary: #5f6d79;
                --brand: #0f8f97;
                --brand-strong: #0a6f82;
                --accent: #ff8a52;
                --shadow-soft: 0 10px 28px rgba(22, 34, 44, 0.1);
                --shadow-card: 0 16px 38px rgba(12, 27, 36, 0.14);
                --radius-lg: 18px;
                --radius-md: 12px;
                --radius-sm: 8px;
            }

            /* === Reset & Base === */
            *,
            *::before,
            *::after {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }
            html {
                font-size: 16px;
                -webkit-text-size-adjust: 100%;
            }
            body {
                font-family:
                    "Plus Jakarta Sans",
                    -apple-system,
                    BlinkMacSystemFont,
                    "Segoe UI",
                    "Helvetica Neue",
                    Arial,
                    sans-serif;
                line-height: 1.5;
                color: var(--text-primary);
                background:
                    radial-gradient(
                        circle at 10% 6%,
                        #d9efe5 0%,
                        rgba(217, 239, 229, 0) 36%
                    ),
                    radial-gradient(
                        circle at 100% 84%,
                        #ffe7d8 0%,
                        rgba(255, 231, 216, 0) 38%
                    ),
                    var(--bg);
                min-height: 100vh;
                overflow-x: hidden;
            }
            img {
                max-width: 100%;
                height: auto;
                display: block;
            }
            a {
                color: #1a73e8;
                text-decoration: none;
            }
            a:hover {
                text-decoration: underline;
            }
            a:focus-visible,
            button:focus-visible,
            [role="tab"]:focus-visible,
            input:focus-visible {
                outline: 2px solid #1a73e8;
                outline-offset: 2px;
            }

            /* === App Shell === */
            .app-header {
                background: linear-gradient(
                    125deg,
                    #0f8f97 0%,
                    #1aa6a9 42%,
                    #ffc05a 100%
                );
                color: #f7fcff;
                padding: 1rem 1.5rem 1.25rem;
                text-align: center;
                box-shadow: var(--shadow-soft);
                position: sticky;
                top: 0;
                z-index: 100;
                overflow: hidden;
            }
            .app-header::before {
                content: "";
                position: absolute;
                width: 200px;
                height: 200px;
                right: -72px;
                top: -118px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.18);
                pointer-events: none;
            }
            .app-header::after {
                content: "";
                position: absolute;
                width: 145px;
                height: 145px;
                left: -54px;
                bottom: -84px;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.14);
                pointer-events: none;
            }
            .app-header h1 {
                position: relative;
                font-size: 1.34rem;
                font-weight: 600;
                letter-spacing: 0.1px;
                text-shadow: 0 3px 10px rgba(14, 43, 52, 0.25);
            }
            .app-header .trip-dates {
                position: relative;
                font-size: 0.865rem;
                color: rgba(247, 252, 255, 0.88);
                margin-top: 0.25rem;
            }

            /* === Day Tabs === */
            .day-tabs {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                background: rgba(255, 250, 242, 0.8);
                border-bottom: none;
                margin: 0 1rem;
                padding: 0.55rem;
                gap: 0.45rem;
                scrollbar-width: none;
                border: 1px solid #ecdeca;
                border-radius: 16px;
                box-shadow: var(--shadow-soft);
            }
            .day-tabs::-webkit-scrollbar {
                display: none;
            }
            .day-tab {
                flex: 0 0 auto;
                padding: 0.58rem 1.05rem;
                font-size: 0.875rem;
                font-weight: 600;
                letter-spacing: 0.25px;
                color: var(--text-secondary);
                background: #f6efe4;
                border: none;
                cursor: pointer;
                white-space: nowrap;
                transition:
                    color 0.2s,
                    background-color 0.2s,
                    box-shadow 0.2s;
                font-family: inherit;
                border-radius: 999px;
            }
            .day-tab:hover {
                color: var(--text-primary);
                background: #f2e5d3;
            }
            .day-tab[aria-selected="true"] {
                color: #ffffff;
                background: linear-gradient(135deg, var(--brand), #11a6a8);
                box-shadow: 0 6px 14px rgba(15, 63, 83, 0.22);
            }

            /* === Main Content === */
            .day-panel {
                padding: 0.2rem 0 1.2rem;
                max-width: 860px;
                margin: 0 auto;
            }

            /* === Map Section === */
            .map-section {
                background: linear-gradient(180deg, #f8f2e9 0%, #fffdf8 100%);
                margin: 1rem;
                border-radius: var(--radius-lg);
                overflow: hidden;
                box-shadow: var(--shadow-card);
                border: 1px solid #ecdfcc;
            }
            .map-section h2 {
                font-size: 1.03rem;
                font-weight: 600;
                padding: 1rem 1.25rem 0.3rem;
                color: var(--text-primary);
                letter-spacing: 0.2px;
            }
            .map-subtitle {
                display: block;
                padding: 0 1.25rem 0.75rem;
                font-size: 0.85rem;
                color: var(--text-secondary);
                line-height: 1;
            }
            .map-meta {
                display: flex;
                flex-wrap: wrap;
                gap: 0.45rem;
                padding: 0 1.25rem 0.8rem;
            }
            .map-meta-pill {
                display: inline-flex;
                align-items: center;
                gap: 0.3rem;
                font-size: 0.74rem;
                font-weight: 600;
                color: #325362;
                background: #f0e8dc;
                border: 1px solid #e5d4be;
                border-radius: 999px;
                padding: 0.26rem 0.62rem;
            }
            .map-shell {
                position: relative;
            }
            .map-container {
                position: relative;
                width: 100%;
                aspect-ratio: 360 / 280;
                background:
                    linear-gradient(
                        0deg,
                        rgba(209, 233, 224, 0.32),
                        rgba(209, 233, 224, 0)
                    ),
                    #dfe8ea;
                overflow: hidden;
                border-top: 1px solid #eadfce;
                border-bottom: 1px solid #eadfce;
            }
            .map-key-toggle {
                background: rgba(255, 255, 255, 0.1);
                border: 1px solid rgba(255, 255, 255, 0.2);
                color: #f2fbff;
                font-family: inherit;
                font-size: 0.65rem;
                font-weight: 600;
                line-height: 1;
                border-radius: 999px;
                padding: 0.3rem 0.5rem;
                display: inline-flex;
                align-items: center;
                gap: 0.2rem;
                cursor: pointer;
                transition:
                    background-color 0.2s,
                    transform 0.2s;
            }
            .map-key-toggle:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: translateY(-1px);
            }
            .map-key-toggle .material-symbols-outlined {
                font-size: 0.85rem;
            }
            .map-container svg {
                display: block;
                width: 100%;
                height: 100%;
            }
            .map-container svg image {
                opacity: 0.96;
                filter: saturate(1.12) contrast(1.02) hue-rotate(-8deg);
            }
            .map-overlay-key {
                position: absolute;
                top: 0.65rem;
                right: 0.65rem;
                z-index: 4;
                background: linear-gradient(
                    145deg,
                    rgba(9, 29, 36, 0.84),
                    rgba(17, 44, 51, 0.78)
                );
                border: 1px solid rgba(255, 255, 255, 0.18);
                border-radius: 12px;
                color: #f2fbff;
                width: min(190px, 55%);
                box-shadow: 0 12px 24px rgba(3, 18, 24, 0.34);
                backdrop-filter: blur(4px);
                padding: 0.45rem 0.55rem;
                pointer-events: auto;
            }
            .map-overlay-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .map-overlay-title {
                font-size: 0.67rem;
                text-transform: uppercase;
                letter-spacing: 0.7px;
                opacity: 0.92;
                display: inline-flex;
                align-items: center;
                gap: 0.3rem;
                font-weight: 700;
            }
            .map-overlay-grid {
                display: grid;
                grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
                gap: 0.3rem 0.45rem;
                margin-top: 0.3rem;
            }
            .map-overlay-item {
                font-size: 0.66rem;
                display: inline-flex;
                align-items: center;
                gap: 0.32rem;
                white-space: nowrap;
                padding: 0.18rem 0.32rem;
                border-radius: 999px;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.08);
            }
            .map-overlay-icon {
                font-size: 0.84rem;
                line-height: 1;
                width: 1rem;
                height: 1rem;
                border-radius: 50%;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                background: rgba(255, 255, 255, 0.24);
            }
            .map-overlay-swatch {
                width: 0.78rem;
                height: 0.78rem;
                border-radius: 50%;
                border: 2px solid rgba(255, 255, 255, 0.7);
                display: inline-block;
            }
            .map-overlay-item.route .map-overlay-icon,
            .map-overlay-swatch.route {
                background: #0f8f97;
            }
            .map-overlay-item.stop .map-overlay-icon,
            .map-overlay-swatch.stop {
                background: #ff5a5f;
            }
            .map-overlay-item.missing .map-overlay-icon,
            .map-overlay-swatch.missing {
                background: #f9b94f;
            }
            .map-overlay-item.tap .map-overlay-icon,
            .map-overlay-swatch.tap {
                background: #8d88ff;
            }
            .map-unavailable {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
                color: var(--text-secondary);
                font-size: 0.875rem;
                text-align: center;
                padding: 1rem;
            }

            /* === Checklist Section === */
            .checklist-section {
                padding: 0 1rem 1.5rem;
            }
            .checklist-section h2 {
                font-size: 1.03rem;
                font-weight: 600;
                padding: 1rem 0.25rem 0.75rem;
                color: var(--text-primary);
            }

            /* === Activity Card === */
            .activity-card {
                background: var(--surface);
                border-radius: var(--radius-md);
                margin-bottom: 0.75rem;
                box-shadow: var(--shadow-soft);
                overflow: hidden;
                transition:
                    box-shadow 0.2s,
                    transform 0.2s;
                border: 1px solid #ecdeca;
                position: relative;
            }
            .activity-card:hover {
                box-shadow: var(--shadow-card);
                transform: translateY(-1px);
            }
            .activity-header {
                display: flex;
                align-items: center;
                padding: 1rem;
                gap: 1rem;
                cursor: pointer;
                border: none;
                background: transparent;
                width: 100%;
                text-align: left;
                font-family: inherit;
                font-size: 1rem;
                color: var(--text-primary);
            }
            .activity-header:hover {
                background: #fbf5eb;
            }
            .activity-order {
                flex: 0 0 auto;
                width: 2rem;
                height: 2rem;
                border-radius: 50%;
                background: #e7f8f4;
                color: #0b8d89;
                font-size: 0.875rem;
                font-weight: 600;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .activity-name {
                flex: 1;
                font-weight: 500;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            .activity-time {
                flex: 0 0 auto;
                font-size: 0.74rem;
                font-weight: 600;
                color: #325362;
                background: #f0e8dc;
                border: 1px solid #e5d4be;
                border-radius: 999px;
                padding: 0.22rem 0.56rem;
                line-height: 1;
            }
            .activity-expand-icon {
                flex: 0 0 auto;
                font-size: 1.25rem;
                color: #6b7982;
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .activity-card[data-expanded="true"] .activity-name {
                white-space: normal;
                overflow: visible;
                text-overflow: unset;
            }
            .activity-card[data-expanded="true"] .activity-expand-icon {
                transform: rotate(180deg);
            }

            /* === Status Controls === */
            .activity-status {
                display: flex;
                gap: 0.5rem;
                padding: 0 1rem 1rem;
            }
            .status-btn {
                font-family: inherit;
                font-size: 0.875rem;
                font-weight: 600;
                letter-spacing: 0.25px;
                padding: 0.375rem 1rem;
                border-radius: 16px;
                border: 1px solid #e5d9c8;
                background: #ffffff;
                color: #60707a;
                cursor: pointer;
                transition: all 0.2s;
            }
            .status-btn:hover {
                background: #f9f2e7;
                color: var(--text-primary);
            }
            .status-btn[data-active="true"].btn-done {
                background: #e6f4ea;
                color: #137333;
                border-color: #e6f4ea;
            }
            .status-btn[data-active="true"].btn-skipped {
                background: #fef7e0;
                color: #b06000;
                border-color: #fef7e0;
            }
            .activity-map-link {
                margin-left: auto;
            }
            .activity-map-link .material-symbols-outlined {
                font-size: 1rem;
            }

            /* Status visual on card */
            .activity-card[data-status="done"] {
                border-left: 4px solid #137333;
            }
            .activity-card[data-status="skipped"] {
                border-left: 4px solid #f29900;
                opacity: 0.88;
            }
            .activity-card[data-status="done"] .activity-name {
                text-decoration: line-through;
                color: #137333;
            }
            .activity-card[data-status="skipped"] .activity-name {
                text-decoration: line-through;
                color: #b06000;
            }

            /* === Activity Details (expandable) === */
            .activity-details {
                display: none;
                padding: 0 1rem 1rem;
                font-size: 0.875rem;
                color: #33424c;
                border-top: 1px dashed #ebdbc7;
                margin-top: -0.5rem;
                padding-top: 1rem;
            }
            .activity-card[data-expanded="true"] .activity-details {
                display: block;
                animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .detail-image {
                width: 100%;
                border-radius: 8px;
                margin-bottom: 1rem;
                max-height: 250px;
                object-fit: cover;
            }
            .detail-section {
                margin-bottom: 0.875rem;
            }
            .detail-label {
                font-size: 0.75rem;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.8px;
                color: #5f6368;
                margin-bottom: 0.25rem;
            }
            .detail-value {
                line-height: 1.5;
            }
            .detail-value.not-provided {
                color: #80868b;
                font-style: italic;
            }
            .detail-link {
                display: inline-flex;
                align-items: center;
                gap: 0.375rem;
                color: var(--brand-strong);
                font-weight: 500;
            }
            .detail-tips {
                padding-left: 1.5rem;
                margin: 0;
            }
            .detail-tips li {
                margin-bottom: 0.25rem;
            }
            .map-badge {
                display: inline-flex;
                align-items: center;
                gap: 0.25rem;
                font-size: 0.75rem;
                font-weight: 500;
                padding: 0.25rem 0.5rem;
                border-radius: 999px;
                background: #fff1d6;
                color: #9f5900;
                margin-top: 0.25rem;
            }

            /* === Empty State === */
            .empty-state {
                text-align: center;
                padding: 4rem 1.5rem;
                color: var(--text-secondary);
            }
            .empty-state p {
                font-size: 1rem;
            }

            /* === Validation Errors === */
            .validation-errors {
                margin: 1rem;
                padding: 1rem;
                background: #fce9e8;
                border: 1px solid #fad2cf;
                border-radius: 8px;
                display: none;
            }
            .validation-errors.visible {
                display: block;
            }
            .validation-errors h3 {
                font-size: 0.875rem;
                font-weight: 500;
                color: #c5221f;
                margin-bottom: 0.5rem;
            }
            .validation-errors ul {
                padding-left: 1.5rem;
                font-size: 0.875rem;
                color: #b31412;
            }
            .validation-errors li {
                margin-bottom: 0.25rem;
            }

            /* === Map Markers & Route === */
            .map-marker {
                cursor: pointer;
                scroll-margin-top: 96px;
            }
            .map-marker circle {
                transition: r 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .map-marker:hover circle {
                r: 13;
            }
            .map-marker text {
                font-size: 11px;
                font-weight: 600;
                fill: #ffffff;
                text-anchor: middle;
                dominant-baseline: central;
                pointer-events: none;
            }
            .route-line {
                fill: none;
                stroke: #0f8f97;
                stroke-width: 4;
                stroke-dasharray: 7 5;
                stroke-linecap: round;
            }
            .route-line-shadow {
                fill: none;
                stroke: rgba(12, 74, 92, 0.34);
                stroke-width: 6;
                stroke-linecap: round;
            }
            .map-marker-core {
                fill: #ff5a5f;
                stroke: #ffffff;
                stroke-width: 2;
            }
            .map-marker-ring {
                fill: transparent;
                stroke: rgba(255, 90, 95, 0.32);
                stroke-width: 7;
            }
            .map-marker-shadow {
                fill: rgba(20, 24, 30, 0.24);
            }

            /* Map legend */
            .map-legend {
                padding: 0.75rem 1rem 1rem;
                font-size: 0.875rem;
                color: var(--text-secondary);
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
                background: #fff9f1;
            }
            .map-legend-item {
                display: inline-flex;
                align-items: center;
                gap: 0.375rem;
                background: var(--surface-muted);
                border: 1px solid #ebdbc7;
                border-radius: 999px;
                padding: 0.3rem 0.65rem;
            }
            .map-legend-item[data-scroll-to] {
                cursor: pointer;
                transition: background 0.2s, border-color 0.2s;
            }
            .map-legend-item[data-scroll-to]:hover {
                background: #eae3d5;
                border-color: #d4c5a9;
            }
            .map-legend-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #ff5a5f;
            }
            /* === Photo Examples === */
            .photo-examples {
                display: flex;
                gap: 0.75rem;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 0.5rem 0 0.25rem;
                scrollbar-width: thin;
            }
            .photo-examples::-webkit-scrollbar {
                height: 4px;
            }
            .photo-examples::-webkit-scrollbar-thumb {
                background: #d1c4b2;
                border-radius: 4px;
            }
            .photo-example {
                flex: 0 0 auto;
                width: 160px;
                border-radius: var(--radius-sm);
                overflow: hidden;
                border: 1px solid #ecdeca;
                background: var(--surface-muted);
                transition:
                    box-shadow 0.2s,
                    transform 0.2s;
                position: relative;
            }
            .photo-example:hover {
                box-shadow: var(--shadow-card);
                transform: translateY(-2px);
            }
            .photo-example a {
                display: block;
                text-decoration: none;
            }
            .photo-example img {
                width: 160px;
                height: 200px;
                object-fit: cover;
                display: block;
            }
            .photo-example-caption {
                padding: 0.35rem 0.5rem;
                font-size: 0.68rem;
                color: var(--text-secondary);
                line-height: 1.25;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 0.25rem;
            }
            .photo-example-credit {
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                flex: 1;
            }
            .photo-copy-btn {
                flex: 0 0 auto;
                background: none;
                border: 1px solid #e0d5c5;
                border-radius: 6px;
                cursor: pointer;
                padding: 0.2rem 0.4rem;
                font-size: 0.65rem;
                color: var(--text-secondary);
                font-family: inherit;
                transition: all 0.2s;
                display: inline-flex;
                align-items: center;
                gap: 0.2rem;
            }
            .photo-copy-btn:hover {
                background: #f6efe4;
                color: var(--text-primary);
                border-color: #d1c4b2;
            }
            .photo-copy-btn.copied {
                background: #e6f4ea;
                color: #137333;
                border-color: #c4e7cc;
            }

            @media (max-width: 640px) {
                .map-shell {
                    display: flex;
                    flex-direction: column;
                    gap: 0.4rem;
                }
                .map-overlay-key {
                    position: static;
                    align-self: flex-end;
                    width: auto;
                    max-width: min(185px, 100%);
                    padding: 0.35rem 0.45rem;
                }
                .map-key-toggle {
                    font-size: 0.62rem;
                    padding: 0.28rem 0.44rem;
                }
                .map-overlay-grid {
                    grid-template-columns: 1fr;
                    gap: 0.24rem;
                }
            }
        </style>
    </head>
    <body>
        <header class="app-header">
            <h1 id="app-title">Interactive Trip Itinerary</h1>
            <div class="trip-dates" id="app-dates"></div>
        </header>

        <input
            type="file"
            id="file-input"
            accept=".json,application/json"
            aria-label="Load itinerary JSON file"
            hidden
        />
        <span id="file-status" aria-live="polite" hidden></span>

        <div class="validation-errors" id="validation-errors" role="alert">
            <h3>Validation Errors</h3>
            <ul id="validation-error-list"></ul>
        </div>

        <nav aria-label="Trip days">
            <div class="day-tabs" id="day-tabs" role="tablist"></div>
        </nav>

        <main id="day-content" aria-live="polite"></main>

        <script>
            /* ====================================================================
     Interactive Trip Itinerary — Inline Application Script
     ==================================================================== */
            (function () {
                "use strict";

                // ── Schema for validation (embedded from contracts/itinerary-file.schema.json) ──
                const ITINERARY_SCHEMA = {
                    required: ["schemaVersion", "tripId", "title", "days"],
                    properties: {
                        schemaVersion: { type: "string", const: "1.0" },
                        tripId: { type: "string", minLength: 1 },
                        title: { type: "string", minLength: 1 },
                        dateRange: {
                            type: "object",
                            required: ["start", "end"],
                            properties: {
                                start: { type: "string" },
                                end: { type: "string" },
                            },
                        },
                        days: { type: "array", minItems: 1 },
                    },
                    dayRequired: ["dayId", "dayNumber", "label", "activities"],
                    activityRequired: [
                        "activityId",
                        "order",
                        "name",
                        "description",
                        "image",
                        "location",
                        "price",
                        "tips",
                        "photoSpotTips",
                        "ratingSummary",
                        "reviewLinks",
                        "websiteUrl",
                    ],
                };

                // ── App State ──
                const state = {
                    itinerary: null,
                    selectedDayId: null,
                    activityStatuses: {}, // { activityId: 'pending'|'done'|'skipped' }
                    expandedActivityId: null,
                    fileLoadState: "idle", // idle|loading|loaded|validation_error
                    mapFilterKeyHidden: window.innerWidth <= 640,
                };

                // Expose state for testing
                window.__itineraryState = state;

                // ── Validation ──
                function validateItinerary(data) {
                    const errors = [];

                    if (
                        !data ||
                        typeof data !== "object" ||
                        Array.isArray(data)
                    ) {
                        errors.push("Itinerary must be a JSON object.");
                        return errors;
                    }

                    // Required top-level fields
                    for (const field of ITINERARY_SCHEMA.required) {
                        if (!(field in data)) {
                            errors.push(`Missing required field: "${field}".`);
                        }
                    }
                    if (errors.length) return errors;

                    // schemaVersion
                    if (data.schemaVersion !== "1.0") {
                        errors.push(
                            `Invalid schemaVersion: expected "1.0", got "${data.schemaVersion}".`,
                        );
                    }

                    // tripId & title
                    if (
                        typeof data.tripId !== "string" ||
                        data.tripId.length === 0
                    ) {
                        errors.push('"tripId" must be a non-empty string.');
                    }
                    if (
                        typeof data.title !== "string" ||
                        data.title.length === 0
                    ) {
                        errors.push('"title" must be a non-empty string.');
                    }

                    // dateRange (optional)
                    if ("dateRange" in data && data.dateRange !== undefined) {
                        if (
                            !data.dateRange ||
                            typeof data.dateRange !== "object"
                        ) {
                            errors.push(
                                '"dateRange" must be an object with "start" and "end".',
                            );
                        } else {
                            if (!data.dateRange.start)
                                errors.push('"dateRange.start" is required.');
                            if (!data.dateRange.end)
                                errors.push('"dateRange.end" is required.');
                            if (data.dateRange.start && data.dateRange.end) {
                                if (
                                    new Date(data.dateRange.end) <
                                    new Date(data.dateRange.start)
                                ) {
                                    errors.push(
                                        '"dateRange.end" must be on or after "dateRange.start".',
                                    );
                                }
                            }
                        }
                    }

                    // days
                    if (!Array.isArray(data.days)) {
                        errors.push('"days" must be an array.');
                        return errors;
                    }
                    if (data.days.length === 0) {
                        errors.push('"days" must contain at least one day.');
                        return errors;
                    }

                    // Unique dayNumber check
                    const dayNumbers = new Set();
                    for (let i = 0; i < data.days.length; i++) {
                        const day = data.days[i];
                        const prefix = `days[${i}]`;

                        for (const f of ITINERARY_SCHEMA.dayRequired) {
                            if (!(f in day)) {
                                errors.push(
                                    `${prefix}: Missing required field "${f}".`,
                                );
                            }
                        }

                        if (typeof day.dayNumber === "number") {
                            if (dayNumbers.has(day.dayNumber)) {
                                errors.push(
                                    `${prefix}: Duplicate dayNumber ${day.dayNumber}.`,
                                );
                            }
                            dayNumbers.add(day.dayNumber);
                        }

                        // Validate activities
                        if (Array.isArray(day.activities)) {
                            const activityOrders = new Set();
                            for (let j = 0; j < day.activities.length; j++) {
                                const act = day.activities[j];
                                const actPrefix = `${prefix}.activities[${j}]`;

                                for (const f of ITINERARY_SCHEMA.activityRequired) {
                                    if (!(f in act)) {
                                        errors.push(
                                            `${actPrefix}: Missing required field "${f}".`,
                                        );
                                    }
                                }

                                if (typeof act.order === "number") {
                                    if (activityOrders.has(act.order)) {
                                        errors.push(
                                            `${actPrefix}: Duplicate order ${act.order} within day.`,
                                        );
                                    }
                                    activityOrders.add(act.order);
                                }

                                // Validate image
                                if (
                                    act.image &&
                                    typeof act.image === "object"
                                ) {
                                    if (!act.image.url)
                                        errors.push(
                                            `${actPrefix}.image: Missing "url".`,
                                        );
                                    if (!act.image.alt)
                                        errors.push(
                                            `${actPrefix}.image: Missing "alt".`,
                                        );
                                } else if (
                                    "image" in act &&
                                    (typeof act.image !== "object" ||
                                        act.image === null)
                                ) {
                                    errors.push(
                                        `${actPrefix}.image: Must be an object with "url" and "alt".`,
                                    );
                                }

                                // Validate location
                                if (
                                    act.location &&
                                    typeof act.location === "object"
                                ) {
                                    if (!act.location.mapsUrl)
                                        errors.push(
                                            `${actPrefix}.location: Missing "mapsUrl".`,
                                        );
                                } else if (
                                    "location" in act &&
                                    (typeof act.location !== "object" ||
                                        act.location === null)
                                ) {
                                    errors.push(
                                        `${actPrefix}.location: Must be an object with "mapsUrl".`,
                                    );
                                }

                                // Validate tips arrays
                                if ("tips" in act) {
                                    if (
                                        !Array.isArray(act.tips) ||
                                        act.tips.length === 0
                                    ) {
                                        errors.push(
                                            `${actPrefix}.tips: Must be a non-empty array.`,
                                        );
                                    }
                                }
                                if ("photoSpotTips" in act) {
                                    if (
                                        !Array.isArray(act.photoSpotTips) ||
                                        act.photoSpotTips.length === 0
                                    ) {
                                        errors.push(
                                            `${actPrefix}.photoSpotTips: Must be a non-empty array.`,
                                        );
                                    }
                                }

                                // Validate reviewLinks
                                if (
                                    "reviewLinks" in act &&
                                    act.reviewLinks !== null
                                ) {
                                    if (!Array.isArray(act.reviewLinks)) {
                                        errors.push(
                                            `${actPrefix}.reviewLinks: Must be an array.`,
                                        );
                                    } else {
                                        const sourceNames = new Set();
                                        for (
                                            let k = 0;
                                            k < act.reviewLinks.length;
                                            k++
                                        ) {
                                            const rl = act.reviewLinks[k];
                                            if (!rl.sourceName || !rl.url) {
                                                errors.push(
                                                    `${actPrefix}.reviewLinks[${k}]: Missing "sourceName" or "url".`,
                                                );
                                            }
                                            if (rl.sourceName) {
                                                if (
                                                    sourceNames.has(
                                                        rl.sourceName,
                                                    )
                                                ) {
                                                    errors.push(
                                                        `${actPrefix}.reviewLinks[${k}]: Duplicate sourceName "${rl.sourceName}".`,
                                                    );
                                                }
                                                sourceNames.add(rl.sourceName);
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }

                    return errors;
                }

                // Expose validator for testing
                window.__validateItinerary = validateItinerary;

                // ── State Management ──
                function getActivityStatus(activityId) {
                    return state.activityStatuses[activityId] || "pending";
                }

                function setActivityStatus(activityId, newStatus) {
                    if (!["pending", "done", "skipped"].includes(newStatus))
                        return;
                    state.activityStatuses[activityId] = newStatus;
                    saveStatusesToStorage();
                    // Auto-collapse if expanded
                    if (state.expandedActivityId === activityId) {
                        state.expandedActivityId = null;
                    }
                    renderDayContent();
                }

                function getStorageKey() {
                    const tripId = state.itinerary?.tripId;
                    return tripId ? `itinerary_statuses_${tripId}` : null;
                }

                function saveStatusesToStorage() {
                    try {
                        const key = getStorageKey();
                        if (!key) return;
                        const toSave = {};
                        for (const [id, status] of Object.entries(state.activityStatuses)) {
                            if (status !== "pending") toSave[id] = status;
                        }
                        localStorage.setItem(key, JSON.stringify(toSave));
                    } catch (_) { /* storage unavailable */ }
                }

                function loadStatusesFromStorage() {
                    try {
                        const key = getStorageKey();
                        if (!key) return null;
                        const raw = localStorage.getItem(key);
                        return raw ? JSON.parse(raw) : null;
                    } catch (_) { return null; }
                }

                function toggleExpand(activityId) {
                    state.expandedActivityId =
                        state.expandedActivityId === activityId
                            ? null
                            : activityId;
                    renderDayContent();
                }

                function toggleMapFilterKey() {
                    state.mapFilterKeyHidden = !state.mapFilterKeyHidden;
                    renderDayContent();
                }

                function selectDay(dayId) {
                    if (state.selectedDayId === dayId) return;
                    state.selectedDayId = dayId;
                    renderDayTabs();
                    renderDayContent();
                }

                // Expose for testing
                window.__getActivityStatus = getActivityStatus;
                window.__setActivityStatus = setActivityStatus;
                window.__toggleExpand = toggleExpand;
                window.__selectDay = selectDay;

                // ── Rendering ──
                function getSelectedDay() {
                    if (!state.itinerary) return null;
                    return (
                        state.itinerary.days.find(
                            (d) => d.dayId === state.selectedDayId,
                        ) || null
                    );
                }

                function renderApp() {
                    renderHeader();
                    renderDayTabs();
                    renderDayContent();
                }

                function renderHeader() {
                    const titleEl = document.getElementById("app-title");
                    const datesEl = document.getElementById("app-dates");
                    if (!state.itinerary) {
                        titleEl.textContent = "Interactive Trip Itinerary";
                        datesEl.textContent = "";
                        return;
                    }
                    titleEl.textContent = state.itinerary.title;
                    if (state.itinerary.dateRange) {
                        datesEl.textContent = `${state.itinerary.dateRange.start} — ${state.itinerary.dateRange.end}`;
                    } else {
                        datesEl.textContent = "";
                    }
                }

                function renderDayTabs() {
                    const container = document.getElementById("day-tabs");
                    container.innerHTML = "";
                    if (!state.itinerary) return;

                    state.itinerary.days.forEach((day) => {
                        const tab = document.createElement("button");
                        tab.className = "day-tab";
                        tab.setAttribute("role", "tab");
                        tab.setAttribute(
                            "aria-selected",
                            day.dayId === state.selectedDayId
                                ? "true"
                                : "false",
                        );
                        tab.setAttribute("aria-controls", "day-content");
                        tab.setAttribute("data-day-id", day.dayId);
                        tab.id = `tab-${day.dayId}`;
                        tab.textContent = day.label;
                        tab.addEventListener("click", () =>
                            selectDay(day.dayId),
                        );
                        tab.addEventListener("keydown", (e) =>
                            handleTabKeydown(e, day.dayId),
                        );
                        container.appendChild(tab);
                    });
                }

                function handleTabKeydown(e, currentDayId) {
                    if (!state.itinerary) return;
                    const days = state.itinerary.days;
                    const idx = days.findIndex((d) => d.dayId === currentDayId);
                    let newIdx = -1;

                    if (e.key === "ArrowRight" || e.key === "ArrowDown") {
                        e.preventDefault();
                        newIdx = (idx + 1) % days.length;
                    } else if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
                        e.preventDefault();
                        newIdx = (idx - 1 + days.length) % days.length;
                    } else if (e.key === "Home") {
                        e.preventDefault();
                        newIdx = 0;
                    } else if (e.key === "End") {
                        e.preventDefault();
                        newIdx = days.length - 1;
                    }

                    if (newIdx >= 0) {
                        selectDay(days[newIdx].dayId);
                        const tabEl = document.getElementById(
                            `tab-${days[newIdx].dayId}`,
                        );
                        if (tabEl) tabEl.focus();
                    }
                }

                function renderDayContent() {
                    const container = document.getElementById("day-content");
                    const day = getSelectedDay();

                    if (!state.itinerary) {
                        container.innerHTML =
                            '<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 3rem; color: #dadce0; margin-bottom: 1rem; display: block;">flight_takeoff</span><p>Load an itinerary file to get started.</p></div>';
                        return;
                    }

                    if (!day) {
                        container.innerHTML =
                            '<div class="empty-state"><span class="material-symbols-outlined" style="font-size: 3rem; color: #dadce0; margin-bottom: 1rem; display: block;">calendar_today</span><p>Select a day to view activities.</p></div>';
                        return;
                    }

                    if (!day.activities || day.activities.length === 0) {
                        container.innerHTML = `
          <div class="day-panel" role="tabpanel" aria-labelledby="tab-${day.dayId}">
            <div class="empty-state">
              <span class="material-symbols-outlined" style="font-size: 3rem; color: #dadce0; margin-bottom: 1rem; display: block;">beach_access</span>
              <p>No activities planned for ${day.label}.</p>
            </div>
          </div>`;
                        return;
                    }

                    const sortedActivities = [...day.activities].sort(
                        (a, b) => a.order - b.order,
                    );
                    const mapValidActivities = sortedActivities.filter(
                        (a) =>
                            a.location &&
                            typeof a.location.lat === "number" &&
                            typeof a.location.lng === "number",
                    );

                    let html = `<div class="day-panel" role="tabpanel" aria-labelledby="tab-${day.dayId}">`;

                    // Map section
                    html += renderMapSection(
                        sortedActivities,
                        mapValidActivities,
                    );

                    // Checklist section
                    html +=
                        '<div class="checklist-section"><h2>Activities</h2>';
                    sortedActivities.forEach((act) => {
                        html += renderActivityCard(act);
                    });
                    html += "</div></div>";

                    container.innerHTML = html;

                    // Bind event listeners
                    bindActivityEvents();
                }

                function renderMapSection(
                    sortedActivities,
                    mapValidActivities,
                ) {
                    const mappedCount = mapValidActivities.length;
                    const missingCount = Math.max(
                        0,
                        sortedActivities.length - mappedCount,
                    );
                    let html =
                        '<div class="map-section"><h2>Route Map</h2><div class="map-subtitle">A little visual journey for your day.</div>';
                    const missingPill =
                        missingCount > 0
                            ? `<span class="map-meta-pill"><span class="material-symbols-outlined" style="font-size: 1rem;">location_off</span>${missingCount} missing location${missingCount === 1 ? "" : "s"}</span>`
                            : "";
                    html += `<div class="map-meta"><span class="map-meta-pill"><span class="material-symbols-outlined" style="font-size: 1rem;">route</span>${mappedCount} mapped stop${mappedCount === 1 ? "" : "s"}</span>${missingPill}</div>`;

                    if (mapValidActivities.length === 0) {
                        html +=
                            '<div class="map-container"><div class="map-unavailable"><span class="material-symbols-outlined" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;">map</span>Map data unavailable for this day\'s activities.</div></div>';
                        // Show legend for activities missing map data
                        const missingMap = sortedActivities.filter(
                            (a) =>
                                !a.location ||
                                typeof a.location.lat !== "number" ||
                                typeof a.location.lng !== "number",
                        );
                        if (missingMap.length > 0) {
                            html += '<div class="map-legend">';
                            missingMap.forEach((a) => {
                                html += `<span class="map-legend-item" id="legend-${a.activityId}" data-scroll-to="card-${a.activityId}" role="link" tabindex="0"><span class="map-badge"><span class="material-symbols-outlined" style="font-size: 1rem;">location_off</span> Map unavailable</span> ${escapeHtml(a.name)}</span>`;
                            });
                            html += "</div>";
                        }
                        html += "</div>";
                        return html;
                    }

                    // Compute map geometry
                    const padding = 32;
                    const width = 360;
                    const height = 280;
                    const geometry = buildMapGeometry(
                        mapValidActivities,
                        width,
                        height,
                        padding,
                    );
                    const points = geometry.points;

                    const missingKeyItem =
                        missingCount > 0
                            ? `<span class="map-overlay-item missing"><span class="material-symbols-outlined map-overlay-icon">location_off</span>No map data</span>`
                            : "";
                    const keyButtonLabel = state.mapFilterKeyHidden
                        ? "Show key"
                        : "Hide key";
                    const keyButtonIcon = state.mapFilterKeyHidden
                        ? "visibility"
                        : "visibility_off";
                    const keyButton = `<button class="map-key-toggle" data-action="toggle-map-key" type="button" aria-label="${keyButtonLabel} filter key"><span class="material-symbols-outlined" aria-hidden="true">${keyButtonIcon}</span>${keyButtonLabel}</button>`;
                    const keyPanelContent = state.mapFilterKeyHidden
                        ? ""
                        : `<div class="map-overlay-grid" aria-hidden="true"><span class="map-overlay-item route"><span class="material-symbols-outlined map-overlay-icon">route</span>Route path</span><span class="map-overlay-item stop"><span class="material-symbols-outlined map-overlay-icon">location_on</span>Stops</span>${missingKeyItem}<span class="map-overlay-item tap"><span class="material-symbols-outlined map-overlay-icon">touch_app</span>Tap to open</span></div>`;
                    const keyPanel = `<div class="map-overlay-key"><div class="map-overlay-header"><div class="map-overlay-title" aria-hidden="true"><span class="material-symbols-outlined" style="font-size: 0.95rem;">tune</span>Filter Key</div>${keyButton}</div>${keyPanelContent}</div>`;
                    let svg = `<div class="map-shell">${keyPanel}<div class="map-container"><svg viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Route map for the day">${renderTileLayer(geometry, width, height)}`;

                    // Draw route lines
                    if (points.length >= 2) {
                        for (let i = 0; i < points.length - 1; i++) {
                            svg += `<line class="route-line-shadow" x1="${points[i].x}" y1="${points[i].y}" x2="${points[i + 1].x}" y2="${points[i + 1].y}"/>`;
                            svg += `<line class="route-line" x1="${points[i].x}" y1="${points[i].y}" x2="${points[i + 1].x}" y2="${points[i + 1].y}"/>`;
                        }
                    }

                    // Draw markers
                    points.forEach((p) => {
                        svg += `<g class="map-marker" data-activity-id="${p.activity.activityId}" role="button" tabindex="0" aria-label="Open ${escapeHtml(p.activity.name)} in Google Maps">`;
                        svg += `<circle class="map-marker-shadow" cx="${p.x}" cy="${p.y + 10}" r="6"/>`;
                        svg += `<circle class="map-marker-ring" cx="${p.x}" cy="${p.y}" r="10"/>`;
                        svg += `<circle class="map-marker-core" cx="${p.x}" cy="${p.y}" r="8"/>`;
                        svg += `<text x="${p.x}" y="${p.y}">${p.order}</text>`;
                        svg += `</g>`;
                    });

                    svg += "</svg></div></div>";
                    html += svg;

                    // Map legend (including missing map items)
                    const missingMap = sortedActivities.filter(
                        (a) =>
                            !a.location ||
                            typeof a.location.lat !== "number" ||
                            typeof a.location.lng !== "number",
                    );
                    html += '<div class="map-legend">';
                    mapValidActivities.forEach((a, i) => {
                        html += `<span class="map-legend-item" id="legend-${a.activityId}" data-scroll-to="card-${a.activityId}" role="link" tabindex="0"><span class="map-legend-dot"></span> ${i + 1}. ${escapeHtml(a.name)}</span>`;
                    });
                    if (missingMap.length > 0) {
                        missingMap.forEach((a) => {
                            html += `<span class="map-legend-item" id="legend-${a.activityId}" data-scroll-to="card-${a.activityId}" role="link" tabindex="0"><span class="map-badge"><span class="material-symbols-outlined" style="font-size: 1rem;">location_off</span> Map unavailable</span> ${escapeHtml(a.name)}</span>`;
                        });
                    }
                    html += "</div></div>";
                    return html;
                }

                function buildMapGeometry(activities, width, height, padding) {
                    const availableWidth = width - padding * 2;
                    const availableHeight = height - padding * 2;
                    let zoom = 15;

                    for (let z = 15; z >= 2; z--) {
                        const worldPoints = activities.map((a) =>
                            latLngToWorld(a.location.lat, a.location.lng, z),
                        );
                        const bounds = getBounds(worldPoints);
                        if (
                            bounds.width <= availableWidth &&
                            bounds.height <= availableHeight
                        ) {
                            zoom = z;
                            break;
                        }
                    }

                    const worldPoints = activities.map((a) =>
                        latLngToWorld(a.location.lat, a.location.lng, zoom),
                    );
                    const bounds = getBounds(worldPoints);
                    const centerX = bounds.minX + bounds.width / 2;
                    const centerY = bounds.minY + bounds.height / 2;
                    const mapLeft = centerX - width / 2;
                    const mapTop = centerY - height / 2;

                    return {
                        zoom,
                        mapLeft,
                        mapTop,
                        points: worldPoints.map((point, i) => ({
                            x: point.x - mapLeft,
                            y: point.y - mapTop,
                            order: i + 1,
                            activity: activities[i],
                        })),
                    };
                }

                function latLngToWorld(lat, lng, zoom) {
                    const tileSize = 256;
                    const scale = 2 ** zoom * tileSize;
                    const clampedLat = Math.max(
                        -85.05112878,
                        Math.min(85.05112878, lat),
                    );
                    const sinLat = Math.sin((clampedLat * Math.PI) / 180);
                    const x = ((lng + 180) / 360) * scale;
                    const y =
                        (0.5 -
                            Math.log((1 + sinLat) / (1 - sinLat)) /
                                (4 * Math.PI)) *
                        scale;
                    return { x, y };
                }

                function getBounds(points) {
                    const xs = points.map((p) => p.x);
                    const ys = points.map((p) => p.y);
                    const minX = Math.min(...xs);
                    const maxX = Math.max(...xs);
                    const minY = Math.min(...ys);
                    const maxY = Math.max(...ys);

                    return {
                        minX,
                        minY,
                        maxX,
                        maxY,
                        width: Math.max(1, maxX - minX),
                        height: Math.max(1, maxY - minY),
                    };
                }

                function renderTileLayer(geometry, width, height) {
                    const tileSize = 256;
                    const tileCount = 2 ** geometry.zoom;
                    const minTileX = Math.floor(geometry.mapLeft / tileSize);
                    const maxTileX = Math.floor(
                        (geometry.mapLeft + width) / tileSize,
                    );
                    const minTileY = Math.floor(geometry.mapTop / tileSize);
                    const maxTileY = Math.floor(
                        (geometry.mapTop + height) / tileSize,
                    );

                    let svg = "";

                    for (let tileX = minTileX; tileX <= maxTileX; tileX++) {
                        for (let tileY = minTileY; tileY <= maxTileY; tileY++) {
                            if (tileY < 0 || tileY >= tileCount) continue;

                            const wrappedTileX =
                                ((tileX % tileCount) + tileCount) % tileCount;
                            const x = tileX * tileSize - geometry.mapLeft;
                            const y = tileY * tileSize - geometry.mapTop;
                            const tileUrl = `https://basemaps.cartocdn.com/light_all/${geometry.zoom}/${wrappedTileX}/${tileY}.png`;

                            svg += `<image href="${tileUrl}" x="${x.toFixed(2)}" y="${y.toFixed(2)}" width="${tileSize}" height="${tileSize}" />`;
                        }
                    }

                    return svg;
                }

                function renderActivityCard(act) {
                    const status = getActivityStatus(act.activityId);
                    const isExpanded =
                        state.expandedActivityId === act.activityId;
                    const hasMapData =
                        act.location &&
                        typeof act.location.lat === "number" &&
                        typeof act.location.lng === "number";

                    let html = `<div class="activity-card" id="card-${act.activityId}" data-activity-id="${act.activityId}" data-status="${status}" data-expanded="${isExpanded}">`;

                    // Header (expand/collapse trigger)
                    html += `<button class="activity-header" data-action="toggle" data-activity-id="${act.activityId}" aria-expanded="${isExpanded}" aria-controls="details-${act.activityId}">`;
                    html += `<span class="activity-order">${act.order}</span>`;
                    html += `<span class="activity-name">${escapeHtml(act.name)}</span>`;
                    if (act.time)
                        html += `<span class="activity-time">${escapeHtml(act.time)}</span>`;
                    if (!hasMapData)
                        html += `<span class="map-badge"><span class="material-symbols-outlined" style="font-size: 1rem;">location_off</span> No map</span>`;
                    html += `<span class="material-symbols-outlined activity-expand-icon" aria-hidden="true">expand_more</span>`;
                    html += `</button>`;

                    // Status controls
                    html += `<div class="activity-status">`;
                    html += `<button class="status-btn btn-done" data-action="status" data-activity-id="${act.activityId}" data-status="done" data-active="${status === "done"}" aria-pressed="${status === "done"}" aria-label="Mark ${escapeHtml(act.name)} as done"><span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle; margin-right: 4px;">check_circle</span>Done</button>`;
                    html += `<button class="status-btn btn-skipped" data-action="status" data-activity-id="${act.activityId}" data-status="skipped" data-active="${status === "skipped"}" aria-pressed="${status === "skipped"}" aria-label="Mark ${escapeHtml(act.name)} as skipped"><span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle; margin-right: 4px;">cancel</span>Skip</button>`;
                    html += `<button class="status-btn activity-map-link" data-scroll-to="legend-${act.activityId}" type="button" aria-label="Jump to ${escapeHtml(act.name)} on map"><span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 4px;" aria-hidden="true">map</span>Map</button>`;
                    html += `</div>`;

                    // Expandable details
                    html += `<div class="activity-details" id="details-${act.activityId}" role="region" aria-label="Details for ${escapeHtml(act.name)}">`;
                    html += renderActivityDetails(act);
                    html += `</div>`;

                    html += `</div>`;
                    return html;
                }

                function renderActivityDetails(act) {
                    let html = "";

                    // Image
                    if (act.image && act.image.url) {
                        html += `<img class="detail-image" src="${escapeHtml(act.image.url)}" alt="${escapeHtml(act.image.alt || act.name)}" loading="lazy">`;
                    } else {
                        html += `<div class="detail-section"><span class="detail-label">Image</span><span class="detail-value not-provided">Not provided</span></div>`;
                    }

                    // Description
                    html += `<div class="detail-section"><div class="detail-label">Description</div><div class="detail-value">${escapeHtml(act.description || "")}</div></div>`;

                    // Time
                    html += `<div class="detail-section"><div class="detail-label">Time</div><div class="detail-value${act.time === null || act.time === undefined ? " not-provided" : ""}">${act.time !== null && act.time !== undefined ? escapeHtml(act.time) : "Not provided"}</div></div>`;

                    // Google Maps Link
                    if (act.location && act.location.mapsUrl) {
                        html += `<div class="detail-section"><div class="detail-label">Location</div><div class="detail-value"><a href="${escapeHtml(act.location.mapsUrl)}" target="_blank" rel="noopener noreferrer" class="detail-link" aria-label="Open ${escapeHtml(act.name)} in Google Maps"><span class="material-symbols-outlined" style="font-size: 1.125rem;">location_on</span> Open in Google Maps</a></div></div>`;
                    } else {
                        html += `<div class="detail-section"><div class="detail-label">Location</div><div class="detail-value not-provided">Map data unavailable</div></div>`;
                    }

                    // Price
                    html += `<div class="detail-section"><div class="detail-label">Price</div><div class="detail-value${act.price === null || act.price === undefined ? " not-provided" : ""}">${act.price !== null && act.price !== undefined ? escapeHtml(act.price) : "Not provided"}</div></div>`;

                    // Tips
                    if (act.tips && act.tips.length > 0) {
                        html += `<div class="detail-section"><div class="detail-label">Tips</div><ul class="detail-tips">`;
                        act.tips.forEach((t) => {
                            html += `<li>${escapeHtml(t)}</li>`;
                        });
                        html += `</ul></div>`;
                    } else {
                        html += `<div class="detail-section"><div class="detail-label">Tips</div><div class="detail-value not-provided">Not provided</div></div>`;
                    }

                    // Photo Spot Tips
                    if (act.photoSpotTips && act.photoSpotTips.length > 0) {
                        html += `<div class="detail-section"><div class="detail-label">Photo Spot Tips</div><ul class="detail-tips">`;
                        act.photoSpotTips.forEach((t) => {
                            html += `<li>${escapeHtml(t)}</li>`;
                        });
                        html += `</ul>`;
                        // Photo Examples
                        if (act.photoExamples && act.photoExamples.length > 0) {
                            html += `<div class="detail-label" style="margin-top:0.65rem;font-size:0.7rem;">Example Photos (tap to open, copy link to save)</div>`;
                            html += `<div class="photo-examples">`;
                            act.photoExamples.forEach((pe, idx) => {
                                const safeUrl = escapeHtml(pe.url);
                                const safeAlt = escapeHtml(pe.alt);
                                const safeCredit = pe.credit
                                    ? escapeHtml(pe.credit)
                                    : "";
                                const pageUrl = pe.pageUrl
                                    ? escapeHtml(pe.pageUrl)
                                    : safeUrl;
                                html += `<div class="photo-example">`;
                                html += `<a href="${pageUrl}" target="_blank" rel="noopener noreferrer" title="Open example photo">`;
                                html += `<img src="${safeUrl}" alt="${safeAlt}" loading="lazy" />`;
                                html += `</a>`;
                                html += `<div class="photo-example-caption">`;
                                html += `<span class="photo-example-credit">${safeCredit ? "📷 " + safeCredit : "📷 Unsplash"}</span>`;
                                html += `<button class="photo-copy-btn" data-copy-url="${pageUrl}" title="Copy photo link">Copy</button>`;
                                html += `</div></div>`;
                            });
                            html += `</div>`;
                        }
                        html += `</div>`;
                    } else {
                        html += `<div class="detail-section"><div class="detail-label">Photo Spot Tips</div><div class="detail-value not-provided">Not provided</div></div>`;
                    }

                    // Rating Summary
                    html += `<div class="detail-section"><div class="detail-label">Rating</div><div class="detail-value${act.ratingSummary === null || act.ratingSummary === undefined ? " not-provided" : ""}">${act.ratingSummary !== null && act.ratingSummary !== undefined ? escapeHtml(act.ratingSummary) : "Not provided"}</div></div>`;

                    // Review Links
                    if (act.reviewLinks && act.reviewLinks.length > 0) {
                        html += `<div class="detail-section"><div class="detail-label">Reviews</div><div class="detail-value">`;
                        act.reviewLinks.forEach((rl) => {
                            html += `<a href="${escapeHtml(rl.url)}" target="_blank" rel="noopener noreferrer" class="detail-link" aria-label="Read review on ${escapeHtml(rl.sourceName)}">${escapeHtml(rl.sourceName)}</a> `;
                        });
                        html += `</div></div>`;
                    } else {
                        html += `<div class="detail-section"><div class="detail-label">Reviews</div><div class="detail-value not-provided">No reviews available</div></div>`;
                    }

                    // Website
                    if (act.websiteUrl) {
                        html += `<div class="detail-section"><div class="detail-label">Website</div><div class="detail-value"><a href="${escapeHtml(act.websiteUrl)}" target="_blank" rel="noopener noreferrer" class="detail-link" aria-label="Visit ${escapeHtml(act.name)} website"><span class="material-symbols-outlined" style="font-size: 1.125rem;">language</span> Visit Website</a></div></div>`;
                    } else {
                        html += `<div class="detail-section"><div class="detail-label">Website</div><div class="detail-value not-provided">Not provided</div></div>`;
                    }

                    return html;
                }

                function bindActivityEvents() {
                    // Toggle expand
                    document
                        .querySelectorAll('[data-action="toggle"]')
                        .forEach((btn) => {
                            btn.addEventListener("click", () => {
                                toggleExpand(
                                    btn.getAttribute("data-activity-id"),
                                );
                            });
                        });

                    // Status buttons
                    document
                        .querySelectorAll('[data-action="status"]')
                        .forEach((btn) => {
                            btn.addEventListener("click", () => {
                                const actId =
                                    btn.getAttribute("data-activity-id");
                                const newStatus =
                                    btn.getAttribute("data-status");
                                const currentStatus = getActivityStatus(actId);
                                // Toggle: if already this status, revert to pending
                                if (currentStatus === newStatus) {
                                    setActivityStatus(actId, "pending");
                                } else {
                                    setActivityStatus(actId, newStatus);
                                }
                            });
                        });

                    // Filter key toggle
                    document
                        .querySelectorAll('[data-action="toggle-map-key"]')
                        .forEach((btn) => {
                            btn.addEventListener("click", () => {
                                toggleMapFilterKey();
                            });
                        });

                    // Cross-link scrolling (legend <-> activity cards)
                    document
                        .querySelectorAll("[data-scroll-to]")
                        .forEach((el) => {
                            const handler = (e) => {
                                e.preventDefault();
                                e.stopPropagation();
                                const targetId = el.getAttribute("data-scroll-to");
                                const target = document.getElementById(targetId);
                                if (target) {
                                    target.scrollIntoView({ behavior: "smooth", block: "center" });
                                    target.style.outline = "2px solid var(--brand)";
                                    target.style.outlineOffset = "2px";
                                    setTimeout(() => {
                                        target.style.outline = "";
                                        target.style.outlineOffset = "";
                                    }, 1500);
                                }
                            };
                            el.addEventListener("click", handler);
                            el.addEventListener("keydown", (e) => {
                                if (e.key === "Enter" || e.key === " ") {
                                    handler(e);
                                }
                            });
                        });

                    // Map marker clicks
                    document
                        .querySelectorAll(".map-marker")
                        .forEach((marker) => {
                            const handler = () => {
                                const actId =
                                    marker.getAttribute("data-activity-id");
                                if (!state.itinerary) return;
                                const day = getSelectedDay();
                                if (!day) return;
                                const act = day.activities.find(
                                    (a) => a.activityId === actId,
                                );
                                if (
                                    act &&
                                    act.location &&
                                    act.location.mapsUrl
                                ) {
                                    window.open(
                                        act.location.mapsUrl,
                                        "_blank",
                                        "noopener,noreferrer",
                                    );
                                }
                            };
                            marker.addEventListener("click", handler);
                            marker.addEventListener("keydown", (e) => {
                                if (e.key === "Enter" || e.key === " ") {
                                    e.preventDefault();
                                    handler();
                                }
                            });
                        });

                    // Photo copy buttons
                    document
                        .querySelectorAll(".photo-copy-btn")
                        .forEach((btn) => {
                            btn.addEventListener("click", async (e) => {
                                e.preventDefault();
                                const url = btn.getAttribute("data-copy-url");
                                try {
                                    await navigator.clipboard.writeText(url);
                                    btn.textContent = "Copied!";
                                    btn.classList.add("copied");
                                    setTimeout(() => {
                                        btn.textContent = "Copy";
                                        btn.classList.remove("copied");
                                    }, 1500);
                                } catch {
                                    // Fallback for older browsers
                                    const ta =
                                        document.createElement("textarea");
                                    ta.value = url;
                                    ta.style.position = "fixed";
                                    ta.style.opacity = "0";
                                    document.body.appendChild(ta);
                                    ta.select();
                                    document.execCommand("copy");
                                    document.body.removeChild(ta);
                                    btn.textContent = "Copied!";
                                    btn.classList.add("copied");
                                    setTimeout(() => {
                                        btn.textContent = "Copy";
                                        btn.classList.remove("copied");
                                    }, 1500);
                                }
                            });
                        });
                }

                // ── File Loading ──
                function loadItinerary(data, { restoreFromStorage = false } = {}) {
                    state.fileLoadState = "loading";
                    updateFileStatus("Loading...", "");

                    const errors = validateItinerary(data);
                    if (errors.length > 0) {
                        state.fileLoadState = "validation_error";
                        showValidationErrors(errors);
                        updateFileStatus(
                            "Validation failed — see errors below.",
                            "error",
                        );
                        return false;
                    }

                    // Valid — replace state
                    hideValidationErrors();
                    state.itinerary = data;
                    state.activityStatuses = {};
                    state.expandedActivityId = null;
                    state.selectedDayId = data.days[0]?.dayId || null;
                    state.fileLoadState = "loaded";

                    // Initialize activity statuses
                    const saved = restoreFromStorage ? loadStatusesFromStorage() : null;
                    if (!restoreFromStorage) {
                        // Explicit file load — clear any saved progress
                        try { const key = getStorageKey(); if (key) localStorage.removeItem(key); } catch (_) {}
                    }
                    data.days.forEach((day) => {
                        (day.activities || []).forEach((act) => {
                            state.activityStatuses[act.activityId] =
                                (saved && saved[act.activityId]) || "pending";
                        });
                    });

                    updateFileStatus(
                        "Itinerary loaded successfully.",
                        "success",
                    );
                    renderApp();
                    return true;
                }

                // Expose for testing
                window.__loadItinerary = loadItinerary;

                function showValidationErrors(errors) {
                    const container =
                        document.getElementById("validation-errors");
                    const list = document.getElementById(
                        "validation-error-list",
                    );
                    list.innerHTML = errors
                        .map((e) => `<li>${escapeHtml(e)}</li>`)
                        .join("");
                    container.classList.add("visible");
                }

                function hideValidationErrors() {
                    const container =
                        document.getElementById("validation-errors");
                    container.classList.remove("visible");
                }

                function updateFileStatus(message, statusClass) {
                    const el = document.getElementById("file-status");
                    if (!el) return;
                    el.textContent = message;
                    el.className =
                        "file-status" + (statusClass ? " " + statusClass : "");
                }

                // ── File Input Handler ──
                const fileInputEl = document.getElementById("file-input");
                if (fileInputEl) {
                    fileInputEl.addEventListener("change", async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        try {
                            const text = await file.text();
                            let data;
                            try {
                                data = JSON.parse(text);
                            } catch (parseErr) {
                                state.fileLoadState = "validation_error";
                                showValidationErrors([
                                    `Invalid JSON: ${parseErr.message}`,
                                ]);
                                updateFileStatus("Invalid JSON file.", "error");
                                return;
                            }
                            loadItinerary(data);
                        } catch (err) {
                            state.fileLoadState = "validation_error";
                            showValidationErrors([
                                `Failed to read file: ${err.message}`,
                            ]);
                            updateFileStatus("File read error.", "error");
                        }

                        // Reset input so the same file can be re-loaded
                        e.target.value = "";
                    });
                }

                // ── Utility ──
                function escapeHtml(str) {
                    if (typeof str !== "string") return "";
                    const div = document.createElement("div");
                    div.textContent = str;
                    return div.innerHTML;
                }

                // ── Default Seed Data — Seville Weekend Getaway ──
                const DEFAULT_ITINERARY = {
                    schemaVersion: "1.0",
                    tripId: "seville-weekend-2026",
                    title: "Seville Weekend Getaway",
                    dateRange: { start: "2026-02-27", end: "2026-03-01" },
                    days: [
                        {
                            dayId: "day-1",
                            dayNumber: 1,
                            label: "Friday",
                            date: "2026-02-27",
                            activities: [
                                {
                                    activityId: "fri-1",
                                    order: 1,
                                    time: "09:30 AM",
                                    name: "Breakfast at Billy Brunch Sevilla",
                                    description:
                                        "Kick off the trip with a cozy, trendy brunch spot close to the hotel. Billy Brunch offers a rustic-chic vibe with beautifully plated all-day breakfast options in the heart of Seville.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?w=400",
                                        alt: "Beautifully plated brunch dishes on a rustic table",
                                    },
                                    location: {
                                        lat: 37.3926,
                                        lng: -5.9965,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=3799796081122653283",
                                    },
                                    price: "$$",
                                    tips: [
                                        "Try their signature pancakes or eggs benedict",
                                        "It's close to the hotel and has a cozy, trendy vibe to kick off the trip",
                                    ],
                                    photoSpotTips: [
                                        "Get a shot of the beautifully plated brunch dishes with the rustic-chic table decor",
                                    ],
                                    ratingSummary:
                                        "4.8/5 on Google Maps — Reviewers rave about the friendly service and all-day breakfast standards.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=3799796081122653283",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://billybrunch.com/sevilla/",
                                },
                                {
                                    activityId: "fri-2",
                                    order: 2,
                                    time: "10:30 AM",
                                    name: "Seville Museum of Fine Arts",
                                    description:
                                        "Explore masterpieces by El Greco and Velázquez in this stunning 17th-century former convent. Located in the beautiful Plaza del Museo, it's one of Spain's finest art collections and just a short walk from the hotel.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1554907984-15263bfd63bd?w=400",
                                        alt: "Ornate gallery interior of an art museum",
                                    },
                                    location: {
                                        lat: 37.3943,
                                        lng: -5.9986,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=12964838942455151668",
                                    },
                                    price: "Free (for EU citizens) or €1.50",
                                    tips: [
                                        "Explore masterpieces by El Greco and Velázquez",
                                        "Located in a stunning 17th-century palace right near the hotel, minimizing walking early on",
                                    ],
                                    photoSpotTips: [
                                        "The ornate courtyards and cloisters provide stunning, elegant backdrops without the heavy crowds of the Alcázar",
                                    ],
                                    ratingSummary:
                                        "4.7/5 on Google Maps — Highly rated for its peaceful atmosphere and impressive Andalusian art collection.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=12964838942455151668",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://www.museosdeandalucia.es/web/museodebellasartesdesevilla",
                                },
                                {
                                    activityId: "fri-3",
                                    order: 3,
                                    time: "12:30 PM",
                                    name: "Supermarket Run at Mercadona",
                                    description:
                                        "Quick and practical grocery stop at the Mercadona near Plaza de Armas. Stock up on bottled water, cheap local wines, jamón, and snacks for the hotel room.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1604719312566-8912e9227c6a?w=400",
                                        alt: "Well-stocked supermarket aisle",
                                    },
                                    location: {
                                        lat: 37.3923,
                                        lng: -6.002,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=6118353894998285428",
                                    },
                                    price: "$",
                                    tips: [
                                        "Stock up on bottled water, cheap local wines, jamón, and snacks for the hotel room",
                                        "Great value and just a short walk from the museum",
                                    ],
                                    photoSpotTips: [
                                        "N/A — just a practical grocery stop!",
                                    ],
                                    ratingSummary:
                                        "4.2/5 on Google Maps — Reliable chain, appreciated by locals and tourists for its wide selection of affordable local produce.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=6118353894998285428",
                                        },
                                    ],
                                    websiteUrl: "https://www.mercadona.es/",
                                },
                                {
                                    activityId: "fri-4",
                                    order: 4,
                                    time: "01:30 PM",
                                    name: "Tapas Lunch at Bar Dos de Mayo",
                                    description:
                                        "A highly rated, casual tapas spot in a lively square. Sit outdoors if possible, order regional specialties, and share 4–5 tapas plates. Known for its robust wine list, homey feel, and authentic traditional food.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1656423521731-9665583f100c?w=400",
                                        alt: "Spanish tapas spread on a restaurant table",
                                    },
                                    location: {
                                        lat: 37.3927,
                                        lng: -5.9917,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=3636918935676928771",
                                    },
                                    price: "$$",
                                    tips: [
                                        "Sit outdoors in the square if possible",
                                        "Order regional specialties and share 4–5 tapas plates among the group",
                                        "Very casual and highly rated",
                                    ],
                                    photoSpotTips: [
                                        "The outdoor seating captures the quintessential vibrant Sevillian street dining vibe",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1740132438754-fcb12ff1eb74?w=400&auto=format",
                                            alt: "Friends enjoying outdoor tapas dining at a European café terrace",
                                            credit: "MChe Lee",
                                            pageUrl:
                                                "https://unsplash.com/photos/GBHDUPem7g8",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.5/5 on Google Maps — Visitors love the robust wine list, homey feel, and authentic traditional food.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=3636918935676928771",
                                        },
                                    ],
                                    websiteUrl:
                                        "http://www.bodegadosdemayo.com/",
                                },
                                {
                                    activityId: "fri-5",
                                    order: 5,
                                    time: "04:00 PM",
                                    name: "Shopping on Calle Sierpes at Natura",
                                    description:
                                        "Stroll down Seville's main pedestrian shopping street, Calle Sierpes. Natura offers great boho clothes and cute gifts/souvenirs. Keep an eye out for independent boutiques along the charming side streets.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?w=400",
                                        alt: "Pedestrian shopping street with boutiques",
                                    },
                                    location: {
                                        lat: 37.3895,
                                        lng: -5.9941,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=8028310631854923318",
                                    },
                                    price: "$–$$$",
                                    tips: [
                                        "Stroll down Seville's main pedestrian shopping street",
                                        "Natura has great boho clothes and cute gifts/souvenirs",
                                        "Keep an eye out for independent boutiques along the side streets",
                                    ],
                                    photoSpotTips: [
                                        "Capture candid walking shots down the bustling, awning-shaded Calle Sierpes",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1637333245124-db8d75a59b69?w=400&auto=format",
                                            alt: "Woman walking past a yellow building in Sevilla",
                                            credit: "Pier Francesco Grizi",
                                            pageUrl:
                                                "https://unsplash.com/photos/jo5WNr7nTgs",
                                        },
                                        {
                                            url: "https://images.unsplash.com/photo-1761507377433-8d1e26709400?w=400&auto=format",
                                            alt: "People strolling down a narrow shopping street in Seville",
                                            credit: "Jose Manuel Esp",
                                            pageUrl:
                                                "https://unsplash.com/photos/T-bv68Twifg",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.3/5 on Google Maps — Shoppers like the variety of clothes, home goods, and relaxing store ambiance.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=8028310631854923318",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://www.naturaselection.com/",
                                },
                                {
                                    activityId: "fri-6",
                                    order: 6,
                                    time: "06:30 PM",
                                    name: "Sunset at Setas de Sevilla",
                                    description:
                                        "Walk the winding rooftop pathways of the Metropol Parasol, the world's largest wooden structure. Time your visit for golden hour as the sun sets over the city for a truly magical experience and the best panoramic views of Seville.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1583932274573-b39594a7b67a?w=400",
                                        alt: "Metropol Parasol wooden structure against the Seville skyline",
                                    },
                                    location: {
                                        lat: 37.3934,
                                        lng: -5.9917,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=13665238956315169476",
                                    },
                                    price: "€15",
                                    tips: [
                                        "Walk the rooftop pathways for incredible city views",
                                        "Try to time it exactly for golden hour as the sun sets over the city for the best experience",
                                    ],
                                    photoSpotTips: [
                                        "The winding wooden walkways with the city skyline in the background make for the ultimate iconic Instagram photo",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1742749620967-b465e0a82096?w=400&auto=format",
                                            alt: "Woman posing on steps with Seville cityscape in background",
                                            credit: "Will Goodman",
                                            pageUrl:
                                                "https://unsplash.com/photos/PsSrgDo9iNg",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.4/5 on Google Maps — Praised as a unique modern architectural contrast to the old city with the best panoramic views.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=13665238956315169476",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://www.setasdesevilla.com/",
                                },
                                {
                                    activityId: "fri-7",
                                    order: 7,
                                    time: "08:30 PM",
                                    name: "Late Tapas Dinner at Los Coloniales",
                                    description:
                                        "A wildly popular and super affordable classic tapas bar just minutes from Las Setas. Known for generous portions, great sangria, and an unbeatable vibe. Put your name on the chalk waitlist and grab a drink outside while you wait.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1559925393-8be0ec4767c8?w=400",
                                        alt: "Lively tapas bar with patrons dining and drinking",
                                    },
                                    location: {
                                        lat: 37.3939,
                                        lng: -5.9934,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=14305553480244891116",
                                    },
                                    price: "$–$$",
                                    tips: [
                                        "Put your name on the chalk waitlist and grab a drink outside while waiting",
                                        "Generous portions make this a great value dinner spot",
                                        "Try the sangria — it's a crowd favorite",
                                    ],
                                    photoSpotTips: [
                                        "Snap the bustling, lively atmosphere outside with people mingling over drinks while waiting for a table",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1740132438754-fcb12ff1eb74?w=400&auto=format",
                                            alt: "Friends enjoying outdoor tapas dining at a European café terrace",
                                            credit: "MChe Lee",
                                            pageUrl:
                                                "https://unsplash.com/photos/GBHDUPem7g8",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.3/5 on Google Maps — Known for generous portions, great sangria, and an unbeatable vibe.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=14305553480244891116",
                                        },
                                    ],
                                    websiteUrl:
                                        "http://www.tabernacoloniales.es/",
                                },
                            ],
                        },
                        {
                            dayId: "day-2",
                            dayNumber: 2,
                            label: "Saturday",
                            date: "2026-02-28",
                            activities: [
                                {
                                    activityId: "sat-1",
                                    order: 1,
                                    time: "09:30 AM",
                                    name: "Breakfast at La Crème de la Crème",
                                    description:
                                        "Start the day with French pastries, crêpes, or quiches at the sidewalk tables near Las Setas before heading across the river to Triana. A cozy café with excellent sweet treats.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1484723091739-30a097e8f929?w=400",
                                        alt: "French crêpes and pastries on a café table",
                                    },
                                    location: {
                                        lat: 37.3929,
                                        lng: -5.9907,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=6254179950471859009",
                                    },
                                    price: "$$",
                                    tips: [
                                        "Grab some French pastries, crêpes, or quiches at the sidewalk tables near Las Setas",
                                        "Great fuel-up spot before heading across the river to Triana",
                                    ],
                                    photoSpotTips: [
                                        "Snap photos of your coffee and pastries with the modern Las Setas structure towering in the background",
                                    ],
                                    ratingSummary:
                                        "4.5/5 on Google Maps — Loved for its cozy café vibe and excellent sweet treats.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=6254179950471859009",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://www.lacremedelacreme.es/el-mejor-brunch-de-sevilla/",
                                },
                                {
                                    activityId: "sat-2",
                                    order: 2,
                                    time: "11:00 AM",
                                    name: "Explore Mercado de Triana",
                                    description:
                                        "Wander this vibrant indoor market on the Triana side of the river. A great place to buy spices, olive oil, or cured meats as souvenirs, and stop at the stalls inside for a casual midday bite.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1533900298318-6b8da08a523e?w=400",
                                        alt: "Colorful indoor food market with fresh produce stalls",
                                    },
                                    location: {
                                        lat: 37.3862,
                                        lng: -6.004,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=17389346938850283706",
                                    },
                                    price: "Free to enter",
                                    tips: [
                                        "Wander the indoor bazaar — great for spices, olive oil, and cured meats as souvenirs",
                                        "Stop at the stalls inside for a casual midday bite",
                                    ],
                                    photoSpotTips: [
                                        "The colorful fruit, meat, and cheese stalls make for great vibrant, authentic travel photography",
                                    ],
                                    ratingSummary:
                                        "4.4/5 on Google Maps — Reviewers recommend it for its authentic local feel and great tapas stalls inside.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=17389346938850283706",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://mercadodetrianasevilla.com/",
                                },
                                {
                                    activityId: "sat-3",
                                    order: 3,
                                    time: "12:30 PM",
                                    name: "Ceramics Shopping at Santa Ana",
                                    description:
                                        "Triana is historically famous for pottery. Buy authentic, hand-painted ceramic plates or bowls at Cerámica Santa Ana as high-quality, beautiful souvenirs. The shop has a massive selection and centuries of tradition behind it.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1565193566173-7a0ee3dbe261?w=400",
                                        alt: "Hand-painted Andalusian ceramic tiles and pottery",
                                    },
                                    location: {
                                        lat: 37.3833,
                                        lng: -6.0054,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=787557854369862840",
                                    },
                                    price: "$$",
                                    tips: [
                                        "Triana is historically famous for pottery — this is the place to buy authentic souvenirs",
                                        "Buy hand-painted ceramic plates or bowls as high-quality, beautiful keepsakes",
                                    ],
                                    photoSpotTips: [
                                        "The vibrant tiled façade of the building itself is stunning and famous on social media",
                                    ],
                                    ratingSummary:
                                        "4.8/5 on Google Maps — Highly praised for its massive selection, quality craftsmanship, and history.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=787557854369862840",
                                        },
                                    ],
                                    websiteUrl: "http://ceramicasantaana.com/",
                                },
                                {
                                    activityId: "sat-4",
                                    order: 4,
                                    time: "02:00 PM",
                                    name: "Walk Across Puente de Isabel II",
                                    description:
                                        "Walk back to the city center across the iconic Triana Bridge (Puente de Isabel II) and enjoy the river path towards the Torre del Oro. The views down the Guadalquivir river are stunning.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1543783207-ec64e4d95325?w=400",
                                        alt: "Scenic river view with a historic bridge in Spain",
                                    },
                                    location: {
                                        lat: 37.3862,
                                        lng: -6.0014,
                                        mapsUrl:
                                            "https://maps.google.com/?q=Puente+de+Isabel+II+Seville",
                                    },
                                    price: "Free",
                                    tips: [
                                        "Enjoy the walk back to the city center along the river path",
                                        "Walk towards the Torre del Oro for the best views",
                                    ],
                                    photoSpotTips: [
                                        "The view from the bridge looking down the Guadalquivir river towards the Torre del Oro is perfect",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1665007019442-180419b71e0d?w=400&auto=format",
                                            alt: "Person walking across a bridge in Seville with river views",
                                            credit: "Hernan Gonzalez",
                                            pageUrl:
                                                "https://unsplash.com/photos/YLgM4h9vxXU",
                                        },
                                    ],
                                    ratingSummary: null,
                                    reviewLinks: [],
                                    websiteUrl: null,
                                },
                                {
                                    activityId: "sat-5",
                                    order: 5,
                                    time: "04:00 PM",
                                    name: "Wander Barrio Santa Cruz & Bodega Santa Cruz",
                                    description:
                                        "Get lost in the narrow streets of the historic Jewish Quarter (Barrio Santa Cruz), then have a cheap and casual standing tapas dinner at Bodega Santa Cruz Las Columnas. Going early avoids the massive crowds.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1555396273-367ea4eb4db5?w=400",
                                        alt: "Narrow alley with overhanging balconies and orange trees in Seville",
                                    },
                                    location: {
                                        lat: 37.3853,
                                        lng: -5.9886,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=5255774528850342695",
                                    },
                                    price: "$–$$",
                                    tips: [
                                        "Get lost in the narrow Jewish Quarter streets — they're magical",
                                        "Have a cheap and very casual standing tapas dinner at the bar",
                                        "Gets busy, so going early (around 4 PM) avoids the massive crowds",
                                    ],
                                    photoSpotTips: [
                                        "The extremely narrow alleys of Santa Cruz with overhanging balconies and orange trees are incredibly photogenic",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1744698276062-a0ffe2246318?w=400&auto=format",
                                            alt: "Woman in pink dress walking through a narrow Seville street",
                                            credit: "Lianhao Qu",
                                            pageUrl:
                                                "https://unsplash.com/photos/D0hAS0BqJeE",
                                        },
                                        {
                                            url: "https://images.unsplash.com/photo-1609701113191-faf488c05744?w=400&auto=format",
                                            alt: "Woman exploring a sunny Andalusia alleyway",
                                            credit: "Amos from Stockphotos.com",
                                            pageUrl:
                                                "https://unsplash.com/photos/8okuQaHrONA",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.4/5 on Google Maps — Famous for its buzzing atmosphere, fast service, and cheap, delicious bites.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=5255774528850342695",
                                        },
                                    ],
                                    websiteUrl:
                                        "http://facebook.com/BodegaSantaCruzSevilla",
                                },
                                {
                                    activityId: "sat-6",
                                    order: 6,
                                    time: "06:30 PM",
                                    name: "Churros at Bar El Comercio",
                                    description:
                                        "Head back into the center for some of the best traditional churros con chocolate in Seville. They serve them thick and doughy in an old-school bar with hanging hams and beautiful tiled walls.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1624471747394-58bffa498291?w=400",
                                        alt: "Traditional churros con chocolate",
                                    },
                                    location: {
                                        lat: 37.3889,
                                        lng: -5.9933,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=14746623062742886370",
                                    },
                                    price: "$",
                                    tips: [
                                        "Head back into the center for some of the best traditional churros con chocolate in the city",
                                        "They serve them thick and doughy here — embrace the indulgence",
                                    ],
                                    photoSpotTips: [
                                        "The old-school interior with hanging hams and tiled walls creates a perfect moody Spanish aesthetic",
                                    ],
                                    ratingSummary:
                                        "4.4/5 on Google Maps — Locals and tourists alike agree they serve some of the best churros in Seville.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=14746623062742886370",
                                        },
                                    ],
                                    websiteUrl: null,
                                },
                                {
                                    activityId: "sat-7",
                                    order: 7,
                                    time: "08:30 PM",
                                    name: "Flamenco & Drinks at La Carbonería",
                                    description:
                                        "An old coal warehouse turned into an impromptu flamenco venue. It's not a formal sit-down show — just grab a pitcher of sangria, sit on the benches, and enjoy the raw, authentic performance in a rustic indoor courtyard.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1535525153412-5a42439a210d?w=400",
                                        alt: "Passionate flamenco performance in a rustic venue",
                                    },
                                    location: {
                                        lat: 37.386,
                                        lng: -5.9863,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=17061238220027078270",
                                    },
                                    price: "Free entry (buy drinks)",
                                    tips: [
                                        "Not a formal sit-down show — grab a pitcher of sangria and sit on the benches",
                                        "Arrive a bit early to get a good spot near the performers",
                                        "The vibe is casual and authentic — just relax and enjoy",
                                    ],
                                    photoSpotTips: [
                                        "The rustic indoor courtyard and fiery performers make for great low-light candid videos",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1662982937651-1e75f5819300?w=400&auto=format",
                                            alt: "Street performers and musicians in a Spanish courtyard",
                                            credit: "David L. Espina Rincon",
                                            pageUrl:
                                                "https://unsplash.com/photos/0auPSkP8DM0",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.3/5 on Google Maps — Beloved for its lack of pretension, free entry, and completely authentic, casual vibe.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=17061238220027078270",
                                        },
                                    ],
                                    websiteUrl:
                                        "http://lacarbonerialevies.blogspot.com.es/",
                                },
                            ],
                        },
                        {
                            dayId: "day-3",
                            dayNumber: 3,
                            label: "Sunday",
                            date: "2026-03-01",
                            activities: [
                                {
                                    activityId: "sun-1",
                                    order: 1,
                                    time: "09:30 AM",
                                    name: "Breakfast at MOKAMBO Alfalfa",
                                    description:
                                        "Enjoy a healthy, aesthetic brunch at MOKAMBO near Plaza de la Alfalfa to fuel up for a heavy sightseeing day. Known for excellent brunch options, beautifully presented dishes, and friendly staff.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1525351484163-7529414344d8?w=400",
                                        alt: "Avocado toast and fresh brunch spread at a modern café",
                                    },
                                    location: {
                                        lat: 37.3903,
                                        lng: -5.9905,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=12022455236043524027",
                                    },
                                    price: "$$",
                                    tips: [
                                        "Enjoy a healthy, aesthetic brunch to fuel up for a heavy sightseeing day",
                                        "Great spot for avocado toast, smoothie bowls, and specialty coffee",
                                    ],
                                    photoSpotTips: [
                                        "The beautifully presented avocado toasts and modern interior are great for a food photo",
                                    ],
                                    ratingSummary:
                                        "4.8/5 on Google Maps — Top-rated for its excellent brunch options and friendly staff.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=12022455236043524027",
                                        },
                                    ],
                                    websiteUrl: "http://www.mokambocoffee.com/",
                                },
                                {
                                    activityId: "sun-2",
                                    order: 2,
                                    time: "11:00 AM",
                                    name: "Tour the Royal Alcázar of Seville",
                                    description:
                                        "Spend a couple of hours exploring the magnificent gardens and Moorish palace of the Real Alcázar. A breathtaking UNESCO World Heritage Site featuring stunning tilework, lush gardens, and centuries of history.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1663788225253-0d8458196a8e?w=400",
                                        alt: "Courtyard of the Royal Alcázar of Seville with ornate arches",
                                    },
                                    location: {
                                        lat: 37.3831,
                                        lng: -5.9902,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=13450412327761477255",
                                    },
                                    price: "€14.50",
                                    tips: [
                                        "Spend a couple of hours exploring the gardens and Moorish palace",
                                        "Booking tickets weeks ahead is strictly required as it sells out!",
                                        "Don't miss the underground Baths of Lady María de Padilla",
                                    ],
                                    photoSpotTips: [
                                        "The Baths of Lady María de Padilla (underground arches) and the intricate Courtyard of the Maidens are stunning",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1742749620967-b465e0a82096?w=400&auto=format",
                                            alt: "Woman posing on steps with Seville cityscape in background",
                                            credit: "Will Goodman",
                                            pageUrl:
                                                "https://unsplash.com/photos/PsSrgDo9iNg",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.7/5 on Google Maps — Described as breathtaking and a must-see landmark of Moorish architecture.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=13450412327761477255",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://www.alcazarsevilla.org/",
                                },
                                {
                                    activityId: "sun-3",
                                    order: 3,
                                    time: "02:30 PM",
                                    name: "Catedral de Sevilla & Giralda Tower",
                                    description:
                                        "Visit the world's largest Gothic cathedral and climb the Giralda bell tower (it has ramps, not stairs!) for beautiful panoramic views of Seville. The cathedral opens at 2:30 PM on Sundays.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1562883676-8c7feb83f09b?w=400",
                                        alt: "Seville Cathedral and Giralda Tower against a blue sky",
                                    },
                                    location: {
                                        lat: 37.3861,
                                        lng: -5.9932,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=16473499337161076197",
                                    },
                                    price: "€12",
                                    tips: [
                                        "Opens at 2:30 PM on Sundays — plan accordingly",
                                        "Climb the Giralda tower (it has ramps, not stairs) for beautiful views of the city",
                                        "Don't miss the Patio de los Naranjos (Courtyard of the Orange Trees)",
                                    ],
                                    photoSpotTips: [
                                        "The Patio de los Naranjos (Courtyard of the Orange Trees) inside the cathedral grounds is gorgeous",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1502910288415-7ec2ba6f5086?w=400&auto=format",
                                            alt: "Couple near a historic church in Spain",
                                            credit: "Joshua Newton",
                                            pageUrl:
                                                "https://unsplash.com/photos/_sutqp0Q8pI",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.8/5 on Google Maps — Visitors are awestruck by its massive scale and the views from the bell tower.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=16473499337161076197",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://www.catedraldesevilla.es/",
                                },
                                {
                                    activityId: "sun-4",
                                    order: 4,
                                    time: "04:30 PM",
                                    name: "Afternoon at Plaza de España",
                                    description:
                                        "Seville's most spectacular public square, built for the 1929 Ibero-American Exposition. Featuring a massive half-circle of ornate buildings, a canal with rowboats, and ceramic-tiled alcoves representing each Spanish province.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1590071089561-13691b4a34c0?w=400",
                                        alt: "Plaza de España semicircular building with canal and bridges",
                                    },
                                    location: {
                                        lat: 37.3772,
                                        lng: -5.9869,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=9882856811052390969",
                                    },
                                    price: "Free",
                                    tips: [
                                        "Rent a rowboat in the canal for a fun, relaxing experience",
                                        "Watch for flamenco dancers who often perform in the square",
                                        "Find your home province's ceramic-tiled alcove for a photo",
                                    ],
                                    photoSpotTips: [
                                        "Literally everywhere — sit on the ceramic tiled alcoves representing different Spanish provinces, or on the intricate bridges",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1665007019442-180419b71e0d?w=400&auto=format",
                                            alt: "Person walking across a bridge in Seville with river views",
                                            credit: "Hernan Gonzalez",
                                            pageUrl:
                                                "https://unsplash.com/photos/YLgM4h9vxXU",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.8/5 on Google Maps — Universally loved as one of the most spectacular public squares in the world.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=9882856811052390969",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://www.andalucia.org/es/sevilla-visitas-plaza-de-espana",
                                },
                                {
                                    activityId: "sun-5",
                                    order: 5,
                                    time: "05:30 PM",
                                    name: "Stroll Through Parque de María Luisa",
                                    description:
                                        "This sprawling, romantic park is attached to Plaza de España and is full of fountains, gazebos, and orange trees. Perfect for cooling down in the shade after a busy afternoon of sightseeing.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1585320806297-9794b3e4eeae?w=400",
                                        alt: "Tree-lined pathway in a beautiful Mediterranean park",
                                    },
                                    location: {
                                        lat: 37.3737,
                                        lng: -5.9872,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=7545485340411095106",
                                    },
                                    price: "Free",
                                    tips: [
                                        "This sprawling, romantic park is attached to Plaza de España",
                                        "Full of fountains, gazebos, and orange trees — perfect for cooling down",
                                        "Great for a late-afternoon stroll in the shade",
                                    ],
                                    photoSpotTips: [
                                        "Find the Mount Gurugú waterfall or the hidden tile-covered pavilions for magical photo backdrops",
                                    ],
                                    photoExamples: [
                                        {
                                            url: "https://images.unsplash.com/photo-1744698276062-a0ffe2246318?w=400&auto=format",
                                            alt: "Woman in pink dress walking through a narrow Seville street",
                                            credit: "Lianhao Qu",
                                            pageUrl:
                                                "https://unsplash.com/photos/D0hAS0BqJeE",
                                        },
                                    ],
                                    ratingSummary:
                                        "4.8/5 on Google Maps — Locals love walking the shaded paths in the late afternoon.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=7545485340411095106",
                                        },
                                    ],
                                    websiteUrl:
                                        "https://www.sevilla.org/servicios/medio-ambiente-parques-jardines/parques/parques-y-jardines-historicos/parque-de-maria-luisa",
                                },
                                {
                                    activityId: "sun-6",
                                    order: 6,
                                    time: "07:00 PM",
                                    name: "Farewell Dinner at Ovejas Negras",
                                    description:
                                        "A modern, slightly hip tapas spot with creative dishes — the perfect fun final dinner before heading home. Known for modern twists on classic tapas like risotto and patatas bravas. Gets busy, so arrive right when they open for dinner service.",
                                    image: {
                                        url: "https://images.unsplash.com/photo-1544025162-d76694265947?w=400",
                                        alt: "Creative modern tapas dishes on a stylish table",
                                    },
                                    location: {
                                        lat: 37.3918,
                                        lng: -5.9927,
                                        mapsUrl:
                                            "https://maps.google.com/?cid=14583278816180872665",
                                    },
                                    price: "$$",
                                    tips: [
                                        "A modern, hip tapas spot with creative dishes — perfect for a fun final dinner",
                                        "Gets busy so arrive right when they open for dinner service",
                                        "Try the risotto and the patatas bravas — both are highly recommended",
                                    ],
                                    photoSpotTips: [
                                        "The industrial-chic decor and quirky art make it a very Instagrammable dining spot",
                                    ],
                                    ratingSummary:
                                        "4.4/5 on Google Maps — Highly praised for modern twists on tapas, like their risotto and patatas bravas.",
                                    reviewLinks: [
                                        {
                                            sourceName: "Google Maps",
                                            url: "https://maps.google.com/?cid=14583278816180872665",
                                        },
                                    ],
                                    websiteUrl:
                                        "http://www.ovejasnegrastapas.com/",
                                },
                            ],
                        },
                    ],
                };

                // ── Initialize ──
                loadItinerary(DEFAULT_ITINERARY, { restoreFromStorage: true });
            })();
        </script>
    </body>
</html>
